---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 15-visualization.md in _episodes_rmd/
source: Rmd
title: "Data visualization"
teaching: 0
exercises: 0
questions:
- "How do I visualize data in R?"
objectives:
- "Explore differences between continuous, discrete, nominal, ordinal, and binary data values."
- "Learn to implement a grammar of graphics."
- "Explore plots for different kinds of data values."
- "Build a plot layer by layer."
keypoints:
- ""
- ""
---



~~~
Error in read_csv("../data/blood_storage.csv"): could not find function "read_csv"
~~~
{: .error}
# Visualization (Intro)

## Introduction {#vis-intro-intro}


~~~
library(tidyverse)
library(ggplot2)
~~~
{: .language-r}

[Blood storage dataset description](https://github.com/higgi13425/medicaldata/blob/master/description_docs/blood_storage_desc.pdf)

> [A retrospective cohort study of] 316 men who had undergone radical prostatectomy and recieved tranfusion during or within 30 days of the surgical prodedure
> and had available PSA follow-up data.
> The outcome [of interest] was time to biochemical cancer recurrence.
> Study evaluated the association between red blood cells storage duration and biochemical prostate cancer recurrence after radical prostatectomy.
> Specifically, tested was the hypothesis that perioperative transfution of allogenetic RBCs stored for a prolonged period is associated with earlier biochemical recurrence of prostate cancer after prostatectomy.

Download the blood storage data by [clicking the **Download** button here](https://github.com/higgi13425/medicaldata/blob/master/data/blood_storage.rda). This will load the data directly into RStudio. Check your Environment tab at upper right to see a new data object called `blood_storage`.


~~~
head(blood_storage) # use head to look at the first 6 rows
~~~
{: .language-r}



~~~
Error in head(blood_storage): object 'blood_storage' not found
~~~
{: .error}


~~~
class(blood_storage)
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'blood_storage' not found
~~~
{: .error}



~~~
# get just the column names for a dataset
names(blood_storage)
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'blood_storage' not found
~~~
{: .error}


## Data Types

While exploring a dataset, you want to know what each variable's role in the analysis will be.

- What is the variable (i.e., column) of interest?
  - response, dependent, y, outcome
- which are your predictor variables?
  - predictor, independent variable, x

For each variable, you want to know what possible values it can take on.

<img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/continuous_discrete.png" title="&quot;Continuous Discrete&quot; by Allison Horst." alt="&quot;Continuous Discrete&quot; by Allison Horst." style="display: block; margin: auto;" />

<img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/nominal_ordinal_binary.png" title="&quot;Nominal Ordinal Binary&quot; by Allison Horst." alt="&quot;Nominal Ordinal Binary&quot; by Allison Horst." style="display: block; margin: auto;" />


The type of information a variable holds will dictate the summary statistics you can make,
the visualizations you can create,
and the models you can fit.

Ordinal and discrete variables should be converted into `factor` variables in R.
A `factor` is R's way of naming a **categorical** variable.
This is different from a **character string**, e.g., a person's name.


~~~
recurrence_freq <- blood_storage %>%
  group_by(Recurrence) %>%
  summarize(count = n())
~~~
{: .language-r}



~~~
Error in group_by(., Recurrence): object 'blood_storage' not found
~~~
{: .error}



~~~
recurrence_freq
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'recurrence_freq' not found
~~~
{: .error}

## Grammar of Graphics

<img src="../fig/ggplot-grammar_layers.png" title="The idea behind the grammar of graphics is to decompose graphics into its constitudent layers: data, mapping, statistics, scales, geometries, facets, coordinates, and theme. by Thomas Lin Pedersen." alt="The idea behind the grammar of graphics is to decompose graphics into its constitudent layers: data, mapping, statistics, scales, geometries, facets, coordinates, and theme. by Thomas Lin Pedersen." style="display: block; margin: auto;" />

## Data + geometries


~~~
# add a data layer
ggplot(data = blood_storage)
~~~
{: .language-r}



~~~
Error in ggplot(data = blood_storage): object 'blood_storage' not found
~~~
{: .error}


~~~
# add a data later with an asthetic mapping
ggplot(data = blood_storage, mapping = aes(x = Recurrence))
~~~
{: .language-r}



~~~
Error in ggplot(data = blood_storage, mapping = aes(x = Recurrence)): object 'blood_storage' not found
~~~
{: .error}



~~~
# add a geometry layer
# by default the stat layer for geom_bar will count values
ggplot(data =  blood_storage, mapping = aes(x = Recurrence)) + geom_bar()
~~~
{: .language-r}



~~~
Error in ggplot(data = blood_storage, mapping = aes(x = Recurrence)): object 'blood_storage' not found
~~~
{: .error}

If we have a pre-calculated set of values, we want to tell `geom_bar` to use the `"identity"` statistic.


~~~
recurrence_freq
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'recurrence_freq' not found
~~~
{: .error}


~~~
ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, y = count)) +
  geom_bar(stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, : object 'recurrence_freq' not found
~~~
{: .error}

Something to think about: we have highly unbalanced classes.
This might be something to think about when you fit models and only look at blind performance metrics

100 patients, 99 healthy, 1 sick. If my model classifies healthy *every time*.
It's still 99% correct.

### Layer values

If a value does not exist in a particular layer,
ggplot will try to use data from the previous layer


~~~
# everything in the base layer
ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, y = count)) +
  geom_bar(stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, : object 'recurrence_freq' not found
~~~
{: .error}


~~~
# move astetic mapping to geom layer
ggplot(data = recurrence_freq) +
  geom_bar(mapping = aes(x = Recurrence, y = count), stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq): object 'recurrence_freq' not found
~~~
{: .error}


~~~
# move data to geom layer
ggplot() +
  geom_bar(data = recurrence_freq, mapping = aes(x = Recurrence, y = count), stat = "identity")
~~~
{: .language-r}



~~~
Error in fortify(data): object 'recurrence_freq' not found
~~~
{: .error}

This means we can add more layers with different data sets if we want to.

## Geometries

### Univariate

#### Continuous


~~~
ggplot(blood_storage, aes(x = Age)) + geom_histogram()
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage, aes(x = Age)): object 'blood_storage' not found
~~~
{: .error}


~~~
ggplot(blood_storage, aes(x = Age)) + geom_histogram(bins = 10)
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage, aes(x = Age)): object 'blood_storage' not found
~~~
{: .error}

### Bivariate

The `TVol` column represents the Tumor volume as an ordinal variable

- 1 = Low
- 2 = Medium
- 3 = Extensive

However, the way it is encoded in the dataset is as a (discrete) numeric variable,
even though it actually represents a categorical variable.
To convert the numeric column (or any column) into a categorical **factor** we can use the `as.factor` function.


~~~
# Does not show TVol properly
ggplot(blood_storage) + geom_boxplot(aes(x = TVol, y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}


~~~
# please a box plot for each value of TVol as a factor
ggplot(blood_storage) + geom_boxplot(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}

We can also use a violin plot, to better show the distribution of the dataset,
instead of using a boxplot.

And we can also overlay a different geometry on top.


~~~
ggplot(blood_storage) + 
  geom_violin(aes(x = as.factor(TVol), y = Age)) +
  geom_point(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}


~~~
ggplot(blood_storage) +
  geom_violin(aes(x = as.factor(TVol), y = Age)) +
  geom_jitter(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}

We can move around our data layers to save some typing,
and have the geometry layer use the same data and mapping layer.


~~~
ggplot(blood_storage, aes(x = as.factor(TVol), y = Age)) +
  geom_violin() +
  geom_jitter()
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage, aes(x = as.factor(TVol), y = Age)): object 'blood_storage' not found
~~~
{: .error}

## Other Aesthetic mappings

We can also set other aesthetic mappings, e.g., color

- `PVol`: Prostate volume in grams (g)
- `PreopPSA`: Preoperative prostate specification antigen (PSA) in ng/mL
- `sGS`: Surgical Gleason score
  - 1 = Not assigned
  - 2 = No residual disease or score 0-6
  - 3 = Score 7
  - 4 = Score 8-10


~~~
ggplot(blood_storage) +
  geom_point(aes(x = PVol, y = PreopPSA, color = sGS))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}

Again, we have a numeric variable that is really an ordinal categorical variable


~~~
ggplot(blood_storage) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(sGS)))
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}


## Facets

Facets allow us to re-plot the same figure by separate groups.
Think of this as the `group_by` version for plotting.



~~~
# use facet wrap for a single variable
ggplot(blood_storage) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(sGS))) +
  facet_wrap(~ RBC.Age.Group)
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}


~~~
# use facet grid for 2 variables
ggplot(blood_storage) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(FamHx))) +
  facet_grid(RBC.Age.Group ~ Recurrence)
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}

## Themes


~~~
g <- ggplot(blood_storage) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(FamHx))) +
  facet_grid(RBC.Age.Group ~ Recurrence)
~~~
{: .language-r}



~~~
Error in ggplot(blood_storage): object 'blood_storage' not found
~~~
{: .error}



~~~
g
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}


~~~
g + theme_minimal()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}

Using ggthemes


~~~
library(ggthemes)
~~~
{: .language-r}


~~~
g + theme_wsj()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}


~~~
g + theme_fivethirtyeight()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}



~~~
g + theme_excel()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}



>
> ## Exercise
> 1. Load the 
> [cytomegalovirus dataset](https://github.com/higgi13425/medicaldata/blob/master/data/cytomegalovirus.rda) 
> by clicking the **Download** button and loading the data into RStudio. You can 
> [read more about this data set](https://github.com/higgi13425/medicaldata/blob/master/description_docs/cytomegalovirus_desc.pdf)
> containing measurements from 64 patients who underwent hematopoietic stem cell transplant.
> 2. Bar chart of the `cmv` response variable
>
> 
> ~~~
> ggplot(data = cytomegalovirus) +
> ______(aes(x = ______))
> ~~~
> {: .language-r}
>
> 3. bar plot of `prior.transplant`, colored by `cmv` values
> 
> ~~~
> ggplot(______, aes(as.factor(______))) +  
> geom_bar(aes(fill = as.factor(______)))
> ~~~
> {: .language-r}
> 4. facet by both `donor.cmv` and `recipient.cmv`
> 
> ~~~
> ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> geom_bar(aes(fill = as.factor(cmv))) +  
> ______(______ ~ ______)
> ~~~
> {: .language-r}
> 
> >
> > ## Solution
> > 
> > 
> > ~~~
> > ggplot(data = cytomegalovirus) +  
> > geom_bar(aes(x = cmv))
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-38-1.png" title="plot of chunk unnamed-chunk-38" alt="plot of chunk unnamed-chunk-38" width="612" style="display: block; margin: auto;" />
> > 
> > ~~~
> > ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> > geom_bar(aes(fill = as.factor(cmv)))
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-38-2.png" title="plot of chunk unnamed-chunk-38" alt="plot of chunk unnamed-chunk-38" width="612" style="display: block; margin: auto;" />
> > 
> > ~~~
> > ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> > geom_bar(aes(fill = as.factor(cmv))) +  
> > facet_grid(donor.cmv ~ recipient.cmv)
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-38-3.png" title="plot of chunk unnamed-chunk-38" alt="plot of chunk unnamed-chunk-38" width="612" style="display: block; margin: auto;" />
> >

## Additional Resources

- Ggplot2 reference
  - https://ggplot2.tidyverse.org/reference/index.html
- R Graphics Cookbook
  - 1st edition: http://www.cookbook-r.com/Graphs/
  - 2nd edition: https://r-graphics.org/
- Thomas Lin Pedersen ggplot workshop
  - Slides: https://github.com/thomasp85/ggplot2_workshop
  - Part 1: https://www.youtube.com/watch?v=h29g21z0a68
  - Part 2: https://www.youtube.com/watch?v=0m4yywqNPVY
