---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 15-visualization.md in _episodes_rmd/
source: Rmd
title: "Data visualization"
teaching: 30
exercises: 20
questions:
- "How do I visualize data in R?"
objectives:
- "Explore differences between continuous, discrete, nominal, ordinal, and binary data values."
- "Learn to implement a grammar of graphics."
- "Explore plots for different kinds of data values."
- "Build a plot layer by layer."
keypoints:
- ""
- ""
---


# Visualization

## Introduction {#vis-intro-intro}

(Example: Use side-by-side boxplots to compare two groups, then use two-
sample t-tests on the same data)  Use histograms to investigate shape, and then later in the 
course to verify conditions for hypothesis tests.  

This next section uses a blood storage dataset from a study of prostate cancer
recurrence. This dataset was contributed by Dr. Amy Nowacki, Associate 
Professor, Cleveland Clinic. This dataset is one of many from the 
[`medicaldata` R package](https://higgi13425.github.io/medicaldata/),
curated by Dr. Peter Higgins, M.D. at the
[University of Michigan Medical School](http://www.med.umich.edu/higginslab/).
More information about the blood storage data is available at the 
[TSHS Resources Portal](https://www.causeweb.org/tshs/blood-storage/). A brief
description of the study follows.

> [A retrospective cohort study of] 316 men who had undergone radical 
> prostatectomy and received tranfusion during or within 30 days of the surgical 
> procedure and had available prostate specific antigen (PSA) follow-up data.
> The outcome [of interest] was time to biochemical cancer recurrence.
> The study evaluated the association between red blood cells (RBC) storage 
> duration and biochemical prostate cancer recurrence after radical 
> prostatectomy. Specifically tested was the hypothesis that perioperative 
> transfusion of allogeneic RBCs stored for a prolonged period is associated 
> with earlier biochemical recurrence of prostate cancer after prostatectomy.

To get started, install the `medicaldata` package and load the library. 


~~~
Error in contrib.url(repos, "source"): trying to use CRAN without setting a mirror
~~~
{: .error}

Now access the `blood` dataset within this package. 


~~~
Error: 'blood' is not an exported object from 'namespace:medicaldata'
~~~
{: .error}



~~~
Error in head(blood): object 'blood' not found
~~~
{: .error}


~~~
class(blood)
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'blood' not found
~~~
{: .error}


~~~
# get just the column names for a dataset
names(blood)
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'blood' not found
~~~
{: .error}

## Data Types

While exploring a dataset, you want to know what each variable's role in the 
analysis will be.

- What is the variable (i.e., column) of interest?
  - response, dependent, y, outcome
- which are your predictor variables?
  - predictor, independent variable, x

For each variable, you want to know what possible values it can take on.

<img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/continuous_discrete.png" title="&quot;Continuous Discrete&quot; by Allison Horst." alt="&quot;Continuous Discrete&quot; by Allison Horst." style="display: block; margin: auto;" />

<img src="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/nominal_ordinal_binary.png" title="&quot;Nominal Ordinal Binary&quot; by Allison Horst." alt="&quot;Nominal Ordinal Binary&quot; by Allison Horst." style="display: block; margin: auto;" />

The type of information a variable holds will dictate the summary statistics you 
can make, the visualizations you can create, and the models you can fit.

Ordinal and discrete variables should be converted into `factor` variables in R.
A `factor` is R's way of naming a **categorical** variable.
This is different from a **character string**, e.g., a person's name.

The outcome of interest is the recurrence of cancer (no = 0 or yes = 1).

> ## What kind of variable?
>
> What kind of variable is recurrence?
>
> > ## Solution
> >
> > Recurrence is a binary variable. The cancer either returned or it did not.   
> > These are mutually exclusive outcomes.  
> {: .solution}
{: .challenge}

In cancer studies and other kinds of studies that measure time to an event such 
as cancer recurrence, survival analysis is employed. Read more about how to do
this in Clark TG, Bradburn MJ, Love SB, Altman DG. Survival analysis part I: 
basic concepts and first analyses. British journal of cancer. 2003 Jul;89(2):232-8. https://www.nature.com/articles/6601118

Summarize the number of cancer recurrences and non-recurrences as a recurrence
frequency.


~~~
recurrence_freq <- blood %>%
  group_by(Recurrence) %>%
  summarize(count = n())
~~~
{: .language-r}



~~~
Error in group_by(., Recurrence): object 'blood' not found
~~~
{: .error}



~~~
recurrence_freq
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'recurrence_freq' not found
~~~
{: .error}

This data dictionary describes each variable in the dataset.

To visualize data we will use a grammar of graphics. We build up a visualization
from component parts starting with the data. We can then layer other parts on
top of this data.

## Grammar of Graphics

<img src="../fig/ggplot-grammar_layers.png" title="The idea behind the grammar of graphics is to decompose graphics into its constitudent layers: data, mapping, statistics, scales, geometries, facets, coordinates, and theme. by Thomas Lin Pedersen." alt="The idea behind the grammar of graphics is to decompose graphics into its constitudent layers: data, mapping, statistics, scales, geometries, facets, coordinates, and theme. by Thomas Lin Pedersen." style="display: block; margin: auto;" />

## Data + geometries


~~~
# add a data layer
ggplot(data = blood)
~~~
{: .language-r}



~~~
Error in ggplot(data = blood): object 'blood' not found
~~~
{: .error}


~~~
# add a data later with an asthetic mapping
ggplot(data = blood, mapping = aes(x = Recurrence))
~~~
{: .language-r}



~~~
Error in ggplot(data = blood, mapping = aes(x = Recurrence)): object 'blood' not found
~~~
{: .error}



~~~
# add a geometry layer
# by default the stat layer for geom_bar will count values
ggplot(data =  blood, mapping = aes(x = Recurrence)) + geom_bar()
~~~
{: .language-r}



~~~
Error in ggplot(data = blood, mapping = aes(x = Recurrence)): object 'blood' not found
~~~
{: .error}

If we have a pre-calculated set of values, we want to tell `geom_bar` to use the `"identity"` statistic.


~~~
recurrence_freq
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'recurrence_freq' not found
~~~
{: .error}


~~~
ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, y = count)) +
  geom_bar(stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, : object 'recurrence_freq' not found
~~~
{: .error}

Something to think about: we have highly unbalanced classes.
This might be something to think about when you fit models and only look at blind performance metrics

100 patients, 99 healthy, 1 sick. If my model classifies healthy *every time*.
It's still 99% correct.

### Layer values

If a value does not exist in a particular layer,
ggplot will try to use data from the previous layer


~~~
# everything in the base layer
ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, y = count)) +
  geom_bar(stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq, mapping = aes(x = Recurrence, : object 'recurrence_freq' not found
~~~
{: .error}


~~~
# move astetic mapping to geom layer
ggplot(data = recurrence_freq) +
  geom_bar(mapping = aes(x = Recurrence, y = count), stat = "identity")
~~~
{: .language-r}



~~~
Error in ggplot(data = recurrence_freq): object 'recurrence_freq' not found
~~~
{: .error}


~~~
# move data to geom layer
ggplot() +
  geom_bar(data = recurrence_freq, mapping = aes(x = Recurrence, y = count), stat = "identity")
~~~
{: .language-r}



~~~
Error in fortify(data): object 'recurrence_freq' not found
~~~
{: .error}

This means we can add more layers with different data sets if we want to.

## Geometries

### Univariate

#### Continuous


~~~
ggplot(blood, aes(x = Age)) + geom_histogram()
~~~
{: .language-r}



~~~
Error in ggplot(blood, aes(x = Age)): object 'blood' not found
~~~
{: .error}


~~~
ggplot(blood, aes(x = Age)) + geom_histogram(bins = 10)
~~~
{: .language-r}



~~~
Error in ggplot(blood, aes(x = Age)): object 'blood' not found
~~~
{: .error}

### Bivariate

The `TVol` column represents the Tumor volume as an ordinal variable

- 1 = Low
- 2 = Medium
- 3 = Extensive

However, the way it is encoded in the dataset is as a (discrete) numeric variable,
even though it actually represents a categorical variable.
To convert the numeric column (or any column) into a categorical **factor** we can use the `as.factor` function.


~~~
# Does not show TVol properly
ggplot(blood) + geom_boxplot(aes(x = TVol, y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}


~~~
# please a box plot for each value of TVol as a factor
ggplot(blood) + geom_boxplot(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}

We can also use a violin plot, to better show the distribution of the dataset,
instead of using a boxplot.

And we can also overlay a different geometry on top.


~~~
ggplot(blood) + 
  geom_violin(aes(x = as.factor(TVol), y = Age)) +
  geom_point(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}


~~~
ggplot(blood) +
  geom_violin(aes(x = as.factor(TVol), y = Age)) +
  geom_jitter(aes(x = as.factor(TVol), y = Age))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}

We can move around our data layers to save some typing,
and have the geometry layer use the same data and mapping layer.


~~~
ggplot(blood, aes(x = as.factor(TVol), y = Age)) +
  geom_violin() +
  geom_jitter()
~~~
{: .language-r}



~~~
Error in ggplot(blood, aes(x = as.factor(TVol), y = Age)): object 'blood' not found
~~~
{: .error}

## Other Aesthetic mappings

We can also set other aesthetic mappings, e.g., color

- `PVol`: Prostate volume in grams (g)
- `PreopPSA`: Preoperative prostate specification antigen (PSA) in ng/mL
- `sGS`: Surgical Gleason score
  - 1 = Not assigned
  - 2 = No residual disease or score 0-6
  - 3 = Score 7
  - 4 = Score 8-10


~~~
ggplot(blood) +
  geom_point(aes(x = PVol, y = PreopPSA, color = sGS))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}

Again, we have a numeric variable that is really an ordinal categorical variable


~~~
ggplot(blood) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(sGS)))
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}


## Facets

Facets allow us to re-plot the same figure by separate groups.
Think of this as the `group_by` version for plotting.



~~~
# use facet wrap for a single variable
ggplot(blood) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(sGS))) +
  facet_wrap(~ RBC.Age.Group)
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}


~~~
# use facet grid for 2 variables
ggplot(blood) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(FamHx))) +
  facet_grid(RBC.Age.Group ~ Recurrence)
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}

## Themes


~~~
g <- ggplot(blood) +
  geom_point(aes(x = PVol, y = PreopPSA, color = as.factor(FamHx))) +
  facet_grid(RBC.Age.Group ~ Recurrence)
~~~
{: .language-r}



~~~
Error in ggplot(blood): object 'blood' not found
~~~
{: .error}



~~~
g
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}


~~~
g + theme_minimal()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}

Using ggthemes


~~~
library(ggthemes)
~~~
{: .language-r}


~~~
g + theme_wsj()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}


~~~
g + theme_fivethirtyeight()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}



~~~
g + theme_excel()
~~~
{: .language-r}



~~~
Error in eval(expr, envir, enclos): object 'g' not found
~~~
{: .error}



> ## Exercise
> 1. Load the 
> [cytomegalovirus dataset](https://github.com/higgi13425/medicaldata/blob/master/data/cytomegalovirus.rda) 
> by clicking the **Download** button and loading the data into RStudio. You can 
> [read more about this data set](https://github.com/higgi13425/medicaldata/blob/master/description_docs/cytomegalovirus_desc.pdf)
> containing measurements from 64 patients who underwent hematopoietic stem cell transplant.
> 2. Bar chart of the `cmv` response variable
>
> 
> ~~~
> ggplot(data = cytomegalovirus) +
> ______(aes(x = ______))
> ~~~
> {: .language-r}
>
> 3. bar plot of `prior.transplant`, colored by `cmv` values
> 
> ~~~
> ggplot(______, aes(as.factor(______))) +  
> geom_bar(aes(fill = as.factor(______)))
> ~~~
> {: .language-r}
> 4. facet by both `donor.cmv` and `recipient.cmv`
> 
> ~~~
> ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> geom_bar(aes(fill = as.factor(cmv))) +  
> ______(______ ~ ______)
> ~~~
> {: .language-r}
> 
> >
> > ## Solution
> > 
> > 
> > ~~~
> > ggplot(data = cytomegalovirus) +  
> > geom_bar(aes(x = cmv))
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-36-1.png" title="plot of chunk unnamed-chunk-36" alt="plot of chunk unnamed-chunk-36" width="612" style="display: block; margin: auto;" />
> > 
> > ~~~
> > ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> > geom_bar(aes(fill = as.factor(cmv)))
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-36-2.png" title="plot of chunk unnamed-chunk-36" alt="plot of chunk unnamed-chunk-36" width="612" style="display: block; margin: auto;" />
> > 
> > ~~~
> > ggplot(data = cytomegalovirus, aes(as.factor(prior.transplant))) +  
> > geom_bar(aes(fill = as.factor(cmv))) +  
> > facet_grid(donor.cmv ~ recipient.cmv)
> > ~~~
> > {: .language-r}
> > 
> > <img src="../fig/rmd-15-unnamed-chunk-36-3.png" title="plot of chunk unnamed-chunk-36" alt="plot of chunk unnamed-chunk-36" width="612" style="display: block; margin: auto;" />
> >
> {: .solution}
{: .challenge}

## Additional Resources

- Ggplot2 reference
  - https://ggplot2.tidyverse.org/reference/index.html
- R Graphics Cookbook
  - 1st edition: http://www.cookbook-r.com/Graphs/
  - 2nd edition: https://r-graphics.org/
- Thomas Lin Pedersen ggplot workshop
  - Slides: https://github.com/thomasp85/ggplot2_workshop
  - Part 1: https://www.youtube.com/watch?v=h29g21z0a68
  - Part 2: https://www.youtube.com/watch?v=0m4yywqNPVY
